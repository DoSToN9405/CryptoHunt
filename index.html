<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>CryptoHunt Chat</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 10px; background: #f5f7ff; }
    .chat { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: white; }
    .msg { margin: 8px 0; padding: 6px; border-radius: 6px; }
    .puzzle { background: #e0f2fe; }
    .win { background: #dcfce7; font-weight: bold; }
    input, button, select { width: 100%; padding: 10px; margin: 5px 0; }
    #balance { font-size: 18px; font-weight: bold; color: #2563eb; }
  </style>
</head>
<body>
  <h2>üîê CryptoHunt Chat</h2>
  <div>–ë–∞–ª–∞–Ω—Å: <span id="balance">0</span> —Ç–æ–∫–µ–Ω–æ–≤</div>

  <h3>–ó–∞–≥–∞–¥–∞–π –§–†–ê–ó–£ (–ª—é–±–∞—è –¥–ª–∏–Ω–∞!)</h3>
  <input id="secret" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∏—Ç–∫–æ–∏–Ω, Hello, üöÄ">
  <button onclick="createPuzzle()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>

  <h3>–ß–∞—Ç</h3>
  <div class="chat" id="chat"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC9cSHIMOY0qTuvuezfP72vqlm_KUJlqsk",
      authDomain: "cryptohunt-game.firebaseapp.com",
      projectId: "cryptohunt-game",
      storageBucket: "cryptohunt-game.firebasestorage.app",
      messagingSenderId: "834306593429",
      appId: "1:834306593429:web:8a4aa5141c0640315b419c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const messagesRef = db.ref('messages');
    const usersRef = db.ref('users');

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∏–≥—Ä–æ–∫–∞
    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }

    let balance = 0;
    let isHunting = false;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å
    usersRef.child(userId).once('value', (snap) => {
      const data = snap.val();
      if (data) {
        balance = data.balance || 0;
      } else {
        usersRef.child(userId).set({ name: '–ê–Ω–æ–Ω–∏–º', balance: 0 });
      }
      document.getElementById('balance').textContent = balance;
    });

    // –ü—Ä–æ—Å—Ç–æ–π XOR-—à–∏—Ñ—Ä –¥–ª—è –ª—é–±–æ–π —Å—Ç—Ä–æ–∫–∏
    function encrypt(text) {
      const key = 137;
      let encrypted = '';
      for (let i = 0; i < text.length; i++) {
        encrypted += (text.charCodeAt(i) ^ key) + ',';
      }
      return encrypted.slice(0, -1); // –£–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø—è—Ç—É—é
    }

    function decrypt(encryptedStr) {
      const key = 137;
      const codes = encryptedStr.split(',').map(Number);
      let text = '';
      for (const code of codes) {
        text += String.fromCodePoint(code ^ key);
      }
      return text;
    }

    // –°–ª–æ–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ–±–æ—Ä–∞ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å)
    const wordList = [
      '–ë–∏—Ç–∫–æ–∏–Ω', '–≠—Ñ–∏—Ä–∏—É–º', '–ö—Ä–∏–ø—Ç–∞', '–•–µ–ª–ª–æ', '–ü—Ä–∏–≤–µ—Ç', '–°–µ–∫—Ä–µ—Ç', '–§—Ä–∞–∑–∞', '–°–∏–º–≤–æ–ª',
      'üöÄ', '‚Çø', 'ü¶ä', 'üí°', 'üî•', '‚ö°', 'üéâ', 'üòé', 'üß†', 'Hello', 'World', 'Test',
      'Crypto', 'Hunt', 'Game', 'Win', 'Lose', 'Yes', 'No', 'Ok', 'Bye', 'Hi'
    ];

    async function createPuzzle() {
      const secret = document.getElementById('secret').value.trim();
      if (!secret) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ñ—Ä–∞–∑—É!');
        return;
      }
      const encrypted = encrypt(secret);
      const msg = {
        type: 'puzzle',
        encrypted: encrypted,
        reward: 10,
        by: userId,
        timestamp: Date.now()
      };
      await messagesRef.push(msg);
    }

    async function trySolve(encrypted, msgId) {
      if (isHunting) return;
      isHunting = true;

      const words = wordList;
      for (const word of words) {
        if (encrypt(word) === encrypted) {
          // –ü–æ–±–µ–¥–∞!
          balance += 10;
          document.getElementById('balance').textContent = balance;
          await usersRef.child(userId).update({ balance: balance });

          await messagesRef.push({
            type: 'win',
            text: word,
            originalMsg: msgId,
            by: userId,
            reward: 10,
            timestamp: Date.now()
          });

          isHunting = false;
          return;
        }
        await new Promise(r => setTimeout(r, 0));
      }
      isHunting = false;
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–∞—Ç–∞
    function renderMessage(msg, key) {
      const div = document.createElement('div');
      div.className = 'msg ' + msg.type;
      if (msg.type === 'puzzle') {
        div.innerHTML = `üîí <b>–ù–æ–≤–∞—è –∑–∞–≥–∞–¥–∫–∞!</b> –®–∏—Ñ—Ä: ${msg.encrypted.substring(0, 20)}... | –ù–∞–≥—Ä–∞–¥–∞: ${msg.reward} —Ç–æ–∫–µ–Ω–æ–≤`;
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞
        trySolve(msg.encrypted, key);
      } else if (msg.type === 'win') {
        div.innerHTML = `üéâ <b>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ!</b> –°–µ–∫—Ä–µ—Ç: "${msg.text}" | +${msg.reward} —Ç–æ–∫–µ–Ω–æ–≤`;
      }
      document.getElementById('chat').appendChild(div);
      document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    // –°–ª—É—à–∞–µ–º —á–∞—Ç
    messagesRef.limitToLast(20).on('child_added', (snapshot) => {
      renderMessage(snapshot.val(), snapshot.key);
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    messagesRef.limitToLast(20).once('value', (snap) => {
      document.getElementById('chat').innerHTML = '';
      snap.forEach(child => {
        renderMessage(child.val(), child.key);
      });
    });
  </script>
</body>
</html>
