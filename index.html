<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CryptoHunt ‚Äî –ß–∏—Å–ª–æ–≤–∞—è –æ—Ö–æ—Ç–∞</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      background: #f8fafc;
      color: #1e293b;
    }
    h1, h2 { margin: 16px 0; }
    .card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #2563eb; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    #chat {
      height: 250px;
      overflow-y: auto;
      background: white;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .msg { margin: 8px 0; padding: 6px; border-radius: 6px; }
    .puzzle { background: #dbeafe; }
    .win { background: #dcfce7; font-weight: bold; }
    #balance { font-size: 20px; font-weight: bold; color: #2563eb; }
  </style>
</head>
<body>
  <h1>üîê CryptoHunt</h1>
  <div>–ë–∞–ª–∞–Ω—Å: <span id="balance">0</span> —Ç–æ–∫–µ–Ω–æ–≤</div>

  <div class="card">
    <h2>–ó–∞–≥–∞–¥–∞–π —á–∏—Å–ª–æ (–¥–æ 5 —Ü–∏—Ñ—Ä)</h2>
    <input type="number" id="secret" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12345" min="0" max="99999" />
    <button onclick="createPuzzle()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>
  </div>

  <div class="card">
    <h2>–ß–∞—Ç</h2>
    <div id="chat">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ...</div>
  </div>

  <!-- Firebase SDK (compat mode) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
    // === –¢–í–û–Ø FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
    const firebaseConfig = {
      apiKey: "AIzaSyC9cSHIMOY0qTuvuezfP72vqlm_KUJlqsk",
      authDomain: "cryptohunt-game.firebaseapp.com",
      projectId: "cryptohunt-game",
      storageBucket: "cryptohunt-game.firebasestorage.app",
      messagingSenderId: "834306593429",
      appId: "1:834306593429:web:8a4aa5141c0640315b419c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const messagesRef = db.ref('messages');
    const usersRef = db.ref('users');

    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∏–≥—Ä–æ–∫–∞
    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }

    let balance = 0;
    let isHunting = false;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    usersRef.child(userId).once('value', (snap) => {
      const data = snap.val();
      balance = data?.balance || 0;
      document.getElementById('balance').textContent = balance;
      if (!data) usersRef.child(userId).set({ balance: 0 });
    });

    // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ (XOR)
    function encryptNumber(num) {
      const str = num.toString();
      const key = 137;
      let out = '';
      for (let c of str) {
        out += (c.charCodeAt(0) ^ key) + ',';
      }
      return out.slice(0, -1);
    }

    // === –û–¢–ü–†–ê–í–ö–ê –ó–ê–ì–ê–î–ö–ò ===
    async function createPuzzle() {
      const input = document.getElementById('secret').value;
      const num = parseInt(input);
      if (isNaN(num) || num < 0 || num > 99999) {
        alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 99999');
        return;
      }
      const encrypted = encryptNumber(num);
      await messagesRef.push({
        type: 'puzzle',
        encrypted: encrypted,
        reward: 10,
        by: userId,
        timestamp: Date.now()
      });
    }

    // === –ü–û–ò–°–ö –ß–ò–°–õ–ê (—Å –ø–æ—à–∞–≥–æ–≤—ã–º –ø–µ—Ä–µ–±–æ—Ä–æ–º) ===
    async function startHunt(encrypted, msgId) {
      if (isHunting) return;
      isHunting = true;

      const key = 137;
      const max = 99999;
      let i = 0;
      const batchSize = 2000; // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –ø–æ 2000 —á–∏—Å–µ–ª –∑–∞ —Ä–∞–∑

      function encrypt(num) {
        let s = num.toString();
        let out = '';
        for (let c of s) out += (c.charCodeAt(0) ^ key) + ',';
        return out.slice(0, -1);
      }

      function searchBatch() {
        const end = Math.min(i + batchSize, max + 1);
        for (; i < end; i++) {
          if (encrypt(i) === encrypted) {
            // –ù–ê–®–õ–ò!
            balance += 10;
            document.getElementById('balance').textContent = balance;
            usersRef.child(userId).update({ balance: balance });
            messagesRef.push({
              type: 'win',
              text: i.toString(),
              originalMsg: msgId,
              by: userId,
              reward: 10,
              timestamp: Date.now()
            });
            isHunting = false;
            return true;
          }
        }
        return false;
      }

      while (i <= max) {
        if (searchBatch()) return;
        await new Promise(r => setTimeout(r, 10)); // –û—Ç–¥–∞—ë–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
      }
      isHunting = false;
    }

    // === –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ß–ê–¢–ê ===
    function renderMessage(msg, key) {
      const div = document.createElement('div');
      div.className = 'msg ' + msg.type;
      if (msg.type === 'puzzle') {
        div.innerHTML = `üî¢ <b>–ù–æ–≤–∞—è –∑–∞–≥–∞–¥–∫–∞!</b> –®–∏—Ñ—Ä: ${msg.encrypted.substring(0, 20)}... | –ù–∞–≥—Ä–∞–¥–∞: ${msg.reward} —Ç–æ–∫–µ–Ω–æ–≤`;
        startHunt(msg.encrypted, key);
      } else if (msg.type === 'win') {
        div.innerHTML = `üéâ <b>–£–≥–∞–¥–∞–Ω–æ!</b> –ß–∏—Å–ª–æ: <code>${msg.text}</code> | +${msg.reward} —Ç–æ–∫–µ–Ω–æ–≤`;
      }
      document.getElementById('chat').appendChild(div);
      document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É
    messagesRef.limitToLast(20).on('child_added', (snapshot) => {
      renderMessage(snapshot.val(), snapshot.key);
    });

    messagesRef.limitToLast(20).once('value', (snap) => {
      document.getElementById('chat').innerHTML = '';
      snap.forEach(child => renderMessage(child.val(), child.key));
    });
  </script>
</body>
</html>
